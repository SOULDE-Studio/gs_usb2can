# 下载协议文档 (Download Protocol Documentation)

## 概述

这是一个基于8字节固定包的下载协议，兼容CAN总线，参考YMODEM协议设计。协议使用固定8字节帧格式，适合CAN总线等固定长度数据包传输。

## 协议帧格式

每个协议帧固定为8字节，格式如下：

```
Byte 0: 命令类型 (CMD)
Byte 1: 序列号低字节 (SEQ_L)
Byte 2: 序列号高字节 (SEQ_H)
Byte 3: 数据长度 (0-5)
Byte 4-7: 数据载荷 (最多5字节)
```

### 字段说明

- **CMD (Byte 0)**: 命令类型，定义见下文
- **SEQ (Byte 1-2)**: 序列号，小端序，范围0-65535，循环使用
- **Data Length (Byte 3)**: 本帧数据字节数，范围0-5
- **Data (Byte 4-7)**: 数据载荷，最多5字节

## 命令类型

| 命令 | 值 | 说明 |
|------|-----|------|
| CMD_START | 0x01 | 开始传输，包含文件大小和CRC32 |
| CMD_DATA | 0x02 | 数据包 |
| CMD_END | 0x03 | 传输结束 |
| CMD_ACK | 0x06 | 确认 (ACK) |
| CMD_NAK | 0x15 | 否定确认 (NAK) |
| CMD_CANCEL | 0x18 | 取消传输 |

## 协议流程

### 1. 开始传输 (START)

发送方发送START命令，包含固件大小和CRC32：

**帧1 (seq=0)**: 固件大小
```
Byte 0: 0x01 (CMD_START)
Byte 1: 0x00 (SEQ_L = 0)
Byte 2: 0x00 (SEQ_H = 0)
Byte 3: 0x04 (数据长度 = 4)
Byte 4-7: 固件大小 (32位小端序)
```

**帧2 (seq=1, 可选)**: CRC32
```
Byte 0: 0x01 (CMD_START)
Byte 1: 0x01 (SEQ_L = 1)
Byte 2: 0x00 (SEQ_H = 0)
Byte 3: 0x04 (数据长度 = 4)
Byte 4-7: CRC32值 (32位小端序)
```

接收方收到START后：
- 验证固件大小是否有效
- 发送ACK(0)确认第一帧
- 如果收到CRC32帧，发送ACK(1)确认
- 开始准备接收数据

### 2. 数据传输 (DATA)

发送方将固件数据拆分成多个8字节帧发送：

```
Byte 0: 0x02 (CMD_DATA)
Byte 1: SEQ_L (序列号低字节)
Byte 2: SEQ_H (序列号高字节)
Byte 3: 数据长度 (0-5)
Byte 4-7: 数据载荷
```

**数据重组**:
- 接收方将接收到的数据帧重组为128字节的逻辑块
- 当缓冲区达到128字节或接收完所有数据时，写入Flash
- 序列号从0开始递增，支持65535个数据包

**确认机制**:
- 接收方收到正确的数据帧后，发送ACK(seq)
- 如果序列号不匹配，发送NAK(expected_seq)
- 发送方收到NAK后应重发对应序列号的数据包

### 3. 传输结束 (END)

发送方发送END命令：

```
Byte 0: 0x03 (CMD_END)
Byte 1: SEQ_L (最后序列号)
Byte 2: SEQ_H (最后序列号)
Byte 3: 0x00 (无数据)
Byte 4-7: 0x00 (填充)
```

接收方：
- 刷新剩余缓冲区数据到Flash
- 验证接收字节数是否等于固件大小
- 如果CRC32不为0，验证固件CRC32
- 发送ACK确认
- 完成下载

### 4. 错误处理

**超时**: 如果5秒内未收到任何帧，接收方取消传输

**序列号错误**: 发送NAK，请求重发

**CRC32验证失败**: 返回DOWNLOAD_VERIFY_FAILED错误

**取消传输**: 发送CMD_CANCEL命令

## 协议参数

- **帧大小**: 8字节 (固定)
- **每帧最大数据**: 5字节
- **逻辑块大小**: 128字节 (类似YMODEM)
- **最大序列号**: 65535
- **帧超时**: 5秒
- **最大重试次数**: 3次

## 使用示例

### 发送方 (Host)

1. 发送START帧1 (固件大小)
2. 发送START帧2 (CRC32，可选)
3. 等待ACK
4. 循环发送DATA帧，每帧最多5字节数据
5. 等待每个DATA帧的ACK
6. 发送END帧
7. 等待ACK，完成传输

### 接收方 (Bootloader)

1. 等待START帧
2. 解析固件大小和CRC32
3. 发送ACK确认
4. 接收DATA帧，重组数据
5. 每收到正确帧发送ACK
6. 收到END帧后验证并完成

## 兼容性说明

- **CAN总线**: 协议设计为8字节固定帧，完全兼容CAN标准帧格式
- **UART**: 可以通过UART传输，但需要确保每次接收8字节
- **其他接口**: 任何支持8字节固定包传输的接口都可以使用

## 注意事项

1. 序列号循环使用，超过65535后从0开始
2. 数据帧的数据长度可以是0-5之间的任意值
3. CRC32验证是可选的，如果START帧2未发送，CRC32为0，跳过验证
4. 接收方使用128字节缓冲区重组数据，提高Flash写入效率
5. 协议支持断点续传（通过序列号），但当前实现不支持
